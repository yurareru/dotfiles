#!/usr/bin/env bash

tmp_dir="/tmp/cliphist"
rm -rf "$tmp_dir"
mkdir -p "$tmp_dir"

read -r -d '' prog <<EOF
/^[0-9]+\s<meta http-equiv=/ { next }
match(\$0, /^([0-9]+)\s(\[\[\s)?binary.*(jpg|jpeg|png|bmp)/, grp) {
    system("echo " grp[1] "\\\\\t | cliphist decode >$tmp_dir/"grp[1]"."grp[3])
    print \$0"\0icon\x1f$tmp_dir/"grp[1]"."grp[3]
    next
}
1
EOF

while true; do
    selection=$(cliphist list | gawk "$prog" | rofi -dmenu \
        -p "ó°…Œ " \
        -i \
        -kb-delete-entry "" \
        -kb-custom-1 "Shift+Delete")

    ret=$?
    case "$ret" in
        0)
            [[ -n "$selection" ]] && cliphist decode "$selection" | wl-copy
            break
            ;;
        10)
            [[ -n "$selection" ]] && echo "$selection" | cliphist delete
            ;;
        *)
            break
            ;;
    esac
done
