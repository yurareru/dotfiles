#!/usr/bin/env bash

WALLPAPER_DIR="${1:-$HOME/Pictures/Wallpapers}"
CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/wallpapers"
ROFI_THEME="${XDG_CONFIG_HOME:-$HOME/.config}/rofi/wallchanger.rasi"
THUMB_SIZE="400x400"

mkdir -p "$CACHE_DIR"

mapfile -t files < <( find "$WALLPAPER_DIR" -type f \( -iname "*.png" -o -iname "*.jpg" -o -iname "*.jpeg" \))

[[ ${#files[@]} -eq 0 ]] && { notify-send "No wallpapers found"; exit 1; }

input=""
for f in "${files[@]}"; do
    base=$(basename "$f")
    thumb="$CACHE_DIR/$base.jpeg"
    [[ -f "$thumb" ]] || magick "$f" -auto-orient -thumbnail "${THUMB_SIZE}^" -gravity center -extent "$THUMB_SIZE" "$thumb" 
    input+="$base\0icon\x1f$thumb\0info\x1f$f\n"
done

index=$(printf "%b" "$input" | rofi -dmenu \
    -show-icons \
    -p "ó°¸‰ " \
    -format "i" \
    -theme "$ROFI_THEME")

[[ -z "$index" ]] && exit 0

hyprctl hyprpaper preload "${files[$index]}"
hyprctl hyprpaper wallpaper ",${files[$index]}"
